# 基本設計書

## システムアーキテクチャ設計

### 概要

本セクションでは、新人ハッカソン研修向けの**開発生産性管理ツール**の基本設計として、システムアーキテクチャについて概要を示します。本システムは、フロントエンド、バックエンド、データベース、および外部サービス（GitLab API）から構成される典型的な3層アーキテクチャを採用します。

### 技術スタック

- **バックエンド**: Spring Boot (Java)
- **フロントエンド**: HTML/CSS/JavaScript、Bootstrap、jQuery、Chart.js
- **データベース**: PostgreSQL
- **外部サービス**: GitLab API


### 各コンポーネントの概要

#### フロントエンド

- **役割**: ユーザーインターフェースを提供し、ユーザーからの入力を受け取り、バックエンドにリクエストを送信。バックエンドからのレスポンスを受け取り、適切に表示します。
- **技術**:
  - **HTML/CSS/JavaScript**: 基本的な構造とスタイリング、クライアントサイドの動的機能
  - **Bootstrap**: レスポンシブデザインおよびUIコンポーネントの提供
  - **jQuery**: DOM操作およびAjaxリクエストの簡素化
  - **Chart.js**: データのグラフ表示

#### バックエンド

- **役割**: ビジネスロジックの処理、データ管理、外部サービス（GitLab API）との連携を担当します。
- **技術**:
  - **Spring Boot**: フレームワークとして使用し、RESTful APIを提供
  - **Spring Scheduler**: 定期的なバッチ処理のスケジューリング
- **主要機能**:
  - APIエンドポイントの提供
  - メトリクスの収集および管理
  - データのCRUD操作
  - GitLab APIとの連携

#### データベース

- **役割**: システム内のデータを永続的に保存・管理します。
- **技術**: MySQL または PostgreSQL（選定未定）
- **主要テーブル**:
  - **イベント**
  - **チーム**
  - **参加者**
  - **メトリクス**
  - **ブランチルール設定**

#### 外部サービス（GitLab API）

- **役割**: GitLabからのコミット情報、ブランチ情報、テスト結果を取得します。
- **連携方法**:
  - HTTPリクエストを使用してGitLab APIからデータを取得
  - 必要なエンドポイントおよび認証方法の実装

### コンポーネント間のインタラクション

1. **ユーザー操作**:
   - ユーザーがフロントエンド上で操作（例: イベントの作成、メトリクスの表示）を行う
   - フロントエンドがバックエンドに対してHTTPリクエストを送信

2. **バックエンド処理**:
   - バックエンドがリクエストを受け取り、ビジネスロジックを実行
   - 必要に応じてデータベースから情報を取得・更新
   - GitLab APIから必要なデータを取得

3. **データの取得と表示**:
   - バックエンドが処理結果をフロントエンドに返却
   - フロントエンドが受け取ったデータをユーザーに適切な形式（グラフ、表など）で表示

### 非機能要件の考慮

- **パフォーマンス**:
  - バッチ処理は1日1回のスケジュールで実行し、サーバ負荷を最小限に抑える設計
- **セキュリティ**:
  - 基本的な脆弱性対策（XSS、CSRF対策）を実装
  - 認証・認可は現段階では不要だが、将来的な拡張を見越した設計
- **ログ管理**:
  - アプリケーションおよびエラーログを標準出力
- **エラーハンドリング**:
  - 一貫したエラーメッセージの提供とユーザーへの適切なフィードバック

### スケーラビリティと拡張性

- **スケーラビリティ**:
  - 現在の要件では1日1回のバッチ処理で十分だが、将来的な拡張を見越してスケジューリングの柔軟性を確保
- **拡張性**:
  - 新たなメトリクスの追加や機能拡張を容易にするため、モジュール化された設計
  - ユーザ定義メトリクスに対応可能な柔軟なデータ構造

### 開発環境とツール

- **バージョン管理**:
  - Gitを使用し、GitLabリポジトリでソースコードを管理
- **ビルドツール**:
  - Maven
- **IDE**:
  - VSCode

### デプロイメントアーキテクチャ

- **現状**:
  - デプロイ環境は未定のため、ローカル開発環境を想定

## UI/UX設計

### 概要

本セクションでは、新人ハッカソン研修向けの**開発生産性管理ツール**のUI/UX（ユーザーインターフェースおよびユーザーエクスペリエンス）の基本設計について詳細を示します。ユーザビリティを重視し、直感的で操作しやすいインターフェースを提供することを目的とします。また、リッチなUIを実現し、SPA（Single Page Application）のように画面遷移を最小限に抑えた構成とします。

### ユーザー層と要件

- **運営**
  - 全チーム・全イベントのメトリクス収集・集計、サマリー確認、イベント切り替え操作
- **メンター**
  - 自分が担当する（もしくは指定された）チームやイベントのメトリクス確認とフィードバック
- **研修参加者（新人）**
  - 自チームや自分個人のメトリクス、フィードバック結果を参照

### 画面レイアウト

#### メインナビゲーション

- **メインナビゲーションバー**
  - 常に表示され、ユーザーが主要な機能に迅速にアクセスできるようにします。
  - メニュー項目：ダッシュボード、イベント管理、チーム管理、チーム別メトリクス表示画面、メンバー別メトリクス表示画面メトリクス比較、設定
  - ロゴ/システム名を左側に配置

#### 1. ダッシュボード画面（運営・メンター向け）

- **デフォルト表示**: 現在開催中のイベントのメトリクスサマリ（開始日が最新のイベント）
- **機能**:
  - 現在開催中のイベント一覧表示
  - 各イベントのメトリクスサマリ表示
  - イベントの切り替え操作
  - メトリクス収集のキック
- **コンポーネント**:
  - **メトリクスサマリーパネル**: グラフおよび表形式で表示
  - **イベント選択ドロップダウン**: 過去イベントも選択可能。複数イベントが重複している場合、開始日が最新のイベントをデフォルト表示
  - **メトリクス収集キックボタン**: バックエンドに対してメトリクス収集開始をキックする

#### 2. イベント管理画面（運営向け）

- **機能**:
  - イベントの登録、編集、削除
  - イベントID、イベント名、開始日、終了日の設定
- **コンポーネント**:
  - **イベント登録フォーム**: イベント情報を入力
  - **CRUD操作ボタン**: 作成、更新、削除
  - **イベント一覧テーブル**: 登録済みイベントの一覧表示

#### 3. チーム管理画面（運営・メンター向け）

- **機能**:
  - チームの登録、編集、削除
  - チームと紐づくイベントの設定
  - チームメンバー（参加者）の登録、編集、削除
    - 参加者の名前、GitLab IDおよびメールの設定
- **コンポーネント**:
  - **チーム登録フォーム**: チーム名、関連イベントの入力およびチームメンバーの登録
  - **CRUD操作ボタン**: 作成、更新、削除
  - **チーム一覧テーブル**: 登録済みチームの一覧表示

#### 4. チーム別メトリクス表示画面（運営・メンター向け）

- **機能**:
  - 指定されたイベントにおける各チームのメトリクス表示
  - メトリクスのグラフおよび表形式の表示
  - フィードバックメッセージの表示
- **コンポーネント**:
  - **イベント選択ドロップダウン**: イベントを選択してチームを絞り込む
  - **グラフ表示エリア**: Chart.jsを使用したインタラクティブなグラフ
  - **メトリクス詳細表**: 各メトリクスの詳細情報を表形式で表示
  - **フィードバックメッセージパネル**: メトリクスに基づくフィードバックメッセージを表示

#### 5. 参加者別メトリクス表示画面（参加者・メンター向け）(ブランチ戦略チェックも含む)

- **機能**:
  - 指定されたチームにおける各参加者のメトリクス表示
  - メトリクスのグラフおよび表形式の表示
  - フィードバックメッセージの表示
    - 同じイベントに参加するチームと比較して良い指標、悪い指標を一つずつフィードバックする
  - 指定されたチームのブランチ戦略チェック結果の表示
- **コンポーネント**:
  - **チーム選択ドロップダウン**: チームを選択してメンバーを絞り込む
  - **グラフ表示エリア**: Chart.jsを使用したインタラクティブなグラフ
  - **メトリクス詳細表**: 各メトリクスの詳細情報を表形式で表示
  - **ブランチ戦略チェック結果表示エリア**: 選択されたチームのブランチ戦略チェック結果の表示
  - **フィードバックメッセージパネル**: メトリクスに基づくフィードバックメッセージを表示


#### 6. 設定画面（運営向け）

- **機能**:
  - ブランチルールの編集
- **コンポーネント**:
  - **ブランチルール設定フォーム**: ブランチタイプと正規表現を入力
  - **保存ボタン**: 設定を保存
  - **現在の設定表示エリア**: 現在の設定内容を表示


### ユーザビリティとインタラクション

- **ナビゲーション**:
  - トップナビゲーションバーを常に表示し、主要機能への迅速なアクセスを提供
  - 一貫したナビゲーションパターンを採用し、ユーザーの混乱を防止
- **SPAの実現**:
  - ページ遷移を最小限に抑える
  - 必要なデータはAjaxを使用して非同期に取得・更新
  - 画面の主要部分は動的に更新され、リロードなしでコンテンツが変更される

### 色彩とテーマ

- **カラーパレット**:
  - 視認性が高く、メトリクスの状態を直感的に理解できる配色
  - 状態に応じた色分け（例: 緑＝良好、黄色＝注意、赤＝改善必要）
- **一貫したデザイン**:
  - 全画面で統一感のあるデザインを維持
  - UIコンポーネント（ボタン、フォーム、テーブル）の一貫性
- **フォント選定**:
  - 読みやすく、視認性の高いフォントを使用
  - サイズとウェイトの調整による階層的な情報表示

### アクセシビリティ

- **キーボード操作のサポート**:
  - 全ての機能にキーボードからアクセス可能
- **スクリーンリーダー対応**:
  - 適切なARIA属性の設定
- **コントラスト比の確保**:
  - テキストと背景色のコントラスト比を十分に確保し、視認性を向上

### インタラクションデザイン

- **ホバー効果**:
  - ボタンやリンクにホバー時の視覚的フィードバックを追加
- **クリックアクション**:
  - ボタンやリンクのクリック時にアニメーションやトランジションを適用
- **ドラッグ＆ドロップ**:
  - 必要に応じて、リストの並び替えなどにドラッグ＆ドロップ機能を導入

### ユーザビリティ向上のための工夫

- **ツールチップの活用**:
  - ボタンやアイコンに対する説明をツールチップで表示
- **一貫した用語の使用**:
  - 全画面で統一された用語やラベルを使用
- **レスポンシブなフィードバック**:
  - 操作に対する即時フィードバック（例: ローディングスピナー、成功メッセージ）
- **アクセシブルなフォーム**:
  - ラベルと入力フィールドの関連付け
  - 適切なタブ順序の設定

## データベース設計

### 概要

本セクションでは、新人ハッカソン研修向けの**開発生産性管理ツール**のデータベース設計について詳細を示します。データベースはPostgreSQLを使用し、以下の主要テーブルで構成されます。

- イベント（Events）
- チーム（Teams）
- 参加者（Participants）
- メトリクス（Metrics）
- 参加者別メトリクス（ParticipantMetrics）
- ブランチルール設定（BranchRules）
- メトリクス定義（MetricDefinitions）

### テーブル設計

#### 1. イベント（Events）

| カラム名   | データ型    | 制約                              | 説明                           |
|------------|-------------|-----------------------------------|--------------------------------|
| event_id   | VARCHAR(50) | PRIMARY KEY                       | イベントの一意識別子           |
| event_name | VARCHAR(100)| NOT NULL                          | イベント名                     |
| start_date | DATE        | NOT NULL                          | イベント開始日                 |
| end_date   | DATE        | NULLABLE                          | イベント終了日（未定の場合NULL）|
| created_at | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP         | レコード作成日時               |
| updated_at | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP         | レコード更新日時               |

#### 2. チーム（Teams）

| カラム名   | データ型    | 制約                                                            | 説明                           |
|------------|-------------|-----------------------------------------------------------------|--------------------------------|
| team_id    | SERIAL      | PRIMARY KEY                                                     | チームの一意識別子             |
| team_name  | VARCHAR(100)| NOT NULL                                                        | チーム名                       |
| event_id   | VARCHAR(50) | FOREIGN KEY REFERENCES Events(event_id) ON DELETE CASCADE       | 所属イベントのID               |
| created_at | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP                                       | レコード作成日時               |
| updated_at | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP                                       | レコード更新日時               |

#### 3. 参加者（Participants）

| カラム名                | データ型    | 制約                                                           | 説明                           |
|-------------------------|-------------|----------------------------------------------------------------|--------------------------------|
| participant_id          | SERIAL      | PRIMARY KEY                                                    | 参加者の一意識別子             |
| participant_name        | VARCHAR(100)| NOT NULL                                                       | 参加者名                       |
| team_id                 | INTEGER     | FOREIGN KEY REFERENCES Teams(team_id) ON DELETE CASCADE        | 所属チームのID                 |
| participant_gitlab_id   | VARCHAR(100)| NOT NULL                                                       | GitLabユーザ識別子             |
| participant_gitlab_email| VARCHAR(100)| NOT NULL, UNIQUE                                               | GitLabユーザメールアドレス     |
| created_at              | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP                                      | レコード作成日時               |
| updated_at              | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP                                      | レコード更新日時               |

#### 4. メトリクス（Metrics）

| カラム名             | データ型    | 制約                                                                  | 説明                           |
|----------------------|-------------|-----------------------------------------------------------------------|--------------------------------|
| metric_id            | SERIAL      | PRIMARY KEY                                                           | メトリクスの一意識別子         |
| team_id              | INTEGER     | FOREIGN KEY REFERENCES Teams(team_id) ON DELETE CASCADE                | 所属チームのID                 |
| metric_definition_id | INTEGER     | FOREIGN KEY REFERENCES MetricDefinitions(metric_definition_id) ON DELETE CASCADE | メトリクス定義のID        |
| metric_value         | FLOAT       | NOT NULL                                                              | メトリクスの値                 |
| metric_date          | DATE        | NOT NULL                                                              | メトリクス収集日               |
| created_at           | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP                                             | レコード作成日時               |
| updated_at           | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP                                             | レコード更新日時               |

#### 5. 参加者別メトリクス（ParticipantMetrics）

| カラム名                 | データ型    | 制約                                                             | 説明                           |
|--------------------------|-------------|------------------------------------------------------------------|--------------------------------|
| participant_metric_id    | SERIAL      | PRIMARY KEY                                                      | 参加者メトリクスの一意識別子     |
| participant_id           | INTEGER     | FOREIGN KEY REFERENCES Participants(participant_id) ON DELETE CASCADE | 参加者のID               |
| metric_definition_id     | INTEGER     | FOREIGN KEY REFERENCES MetricDefinitions(metric_definition_id) ON DELETE CASCADE | メトリクス定義のID    |
| metric_value             | FLOAT       | NOT NULL                                                         | メトリクスの値                 |
| metric_date              | DATE        | NOT NULL                                                         | メトリクス収集日               |
| created_at               | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP                                        | レコード作成日時               |
| updated_at               | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP                                        | レコード更新日時               |

#### 6. ブランチルール設定（BranchRules）

| カラム名            | データ型    | 制約                                                    | 説明                               |
|---------------------|-------------|---------------------------------------------------------|------------------------------------|
| branch_rule_id      | SERIAL      | PRIMARY KEY                                             | ブランチルールの一意識別子           |
| branch_type         | VARCHAR(50) | NOT NULL                                                | ブランチタイプ（Master/Story/Issue）|
| regex_pattern       | VARCHAR(255)| NOT NULL                                                | ブランチ名の正規表現パターン         |
| parent_branch_type  | VARCHAR(50) | NULLABLE                                                | 生成元ブランチタイプ（StoryからIssueなど）|
| created_at          | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP                               | レコード作成日時                   |
| updated_at          | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP                               | レコード更新日時                   |

#### 7. メトリクス定義（MetricDefinitions）

| カラム名              | データ型    | 制約                      | 説明                           |
|-----------------------|-------------|---------------------------|--------------------------------|
| metric_definition_id  | SERIAL      | PRIMARY KEY                | メトリクス定義の一意識別子       |
| metric_name           | VARCHAR(100)| NOT NULL, UNIQUE           | メトリクス名                     |
| description           | TEXT        | NULLABLE                   | メトリクスの説明                 |
| created_at            | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP  | レコード作成日時               |
| updated_at            | TIMESTAMP   | DEFAULT CURRENT_TIMESTAMP  | レコード更新日時               |

### リレーションシップ

- **イベント（Events）** と **チーム（Teams）** は **1対多** の関係。
- **チーム（Teams）** と **参加者（Participants）** は **1対多** の関係。
- **チーム（Teams）** と **メトリクス（Metrics）** は **1対多** の関係。
- **参加者（Participants）** と **参加者別メトリクス（ParticipantMetrics）** は **1対多** の関係。
- **メトリクス定義（MetricDefinitions）** と **メトリクス（Metrics）** は **1対多** の関係。
- **メトリクス定義（MetricDefinitions）** と **参加者別メトリクス（ParticipantMetrics）** は **1対多** の関係。
- **ブランチルール設定（BranchRules）** は独立したテーブルで、ブランチタイプごとのルールを管理。

### インデックス設計

- **Participants** テーブルの `participant_gitlab_email` に対して **ユニークインデックス** を設定。
- **Metrics** テーブルの `metric_date` と `team_id` に対して **複合インデックス** を設定し、メトリクスの効率的な取得を支援。
- **ParticipantMetrics** テーブルの `participant_id` と `metric_date` に対して **複合インデックス** を設定し、個人メトリクスの効率的な取得を支援。
- **BranchRules** テーブルの `branch_type` に対して **インデックス** を設定。
- **MetricThresholds** テーブルの `metric_definition_id` に対して **インデックス** を設定。

### 制約事項

- **データの一貫性**:
  - 外部キー制約を設けることで、関連するデータの整合性を保証。
- **データの正規化**:
  - データの冗長性を排除し、効率的なデータ管理を実現。
- **ユニーク制約**:
  - 参加者のGitLabメールアドレスはユニークとし、重複を防止。

### データ保持ポリシー

- **イベントデータ**:
  - イベント開催期間中のデータを保持し、過去イベントも参照可能。
  - イベント終了後もデータは削除されず、履歴として保持。
- **メトリクスデータ**:
  - メトリクスの日次スナップショットをイベント開催期間中保持。
  - イベント終了後もメトリクスデータは削除されず、履歴として保持。
- **参加者別メトリクスデータ**:
  - 各参加者のメトリクスも日次で保持し、イベント終了後も履歴として保持。

### トランザクション管理

- **データの整合性**:
  - 複数の関連するデータ操作はトランザクション内で実行し、整合性を保つ。
- **ロック機構**:
  - 高頻度で更新が行われるテーブルに対して適切なロック機構を設け、競合を防止。

### セキュリティ考慮

- **入力バリデーション**:
  - データベースに保存される前に、アプリケーション側で入力データのバリデーションを実施。

### インデックス設計の詳細

| テーブル名              | カラム名                     | インデックスの種類 | 説明                                                   |
|-------------------------|------------------------------|--------------------|--------------------------------------------------------|
| Participants            | participant_gitlab_email     | ユニークインデックス | GitLabメールアドレスの一意性を保証                     |
| Metrics                 | team_id, metric_date         | 複合インデックス     | チーム別および日付別のメトリクス取得を高速化           |
| ParticipantMetrics      | participant_id, metric_date  | 複合インデックス     | 参加者別および日付別のメトリクス取得を高速化           |
| BranchRules             | branch_type                  | インデックス         | ブランチタイプによるルール検索を高速化                 |

## GitLab連携設計

### 概要

本セクションでは、新人ハッカソン研修向けの**開発生産性管理ツール**における**GitLab連携**の設計について詳細を示します。GitLabとの連携により、コミット情報、ブランチ情報、テスト結果などのデータを自動的に取得し、メトリクスの収集および分析を効率化します。本連携は、運営やメンターがチームの開発状況をリアルタイムで把握し、適切なフィードバックを提供するための基盤となります。

### 連携方法

#### 1. 認証および認可

- **認証方式**: GitLab APIへのアクセスには、**Personal Access Token**を使用します。
  - トークンはGitLabのユーザー設定から生成し、必要なスコープを付与します。
- **トークン管理**:
  - トークンおよびGitLabのURLは、アプリケーションの設定ファイル（`application.properties`）に安全に保存します。
- **GitLabのプロジェクトID**
  - 各チームのプロジェクトIDは{イベントID} + "_" + {チーム名}としてください。

#### 2. 使用するGitLab APIエンドポイント

- **コミット情報取得**:
  - エンドポイント: `GET /projects/:id/repository/commits`
  - パラメータ: プロジェクトID、ブランチ名、日付範囲
- **ブランチ情報取得**:
  - エンドポイント: `GET /projects/:id/repository/branches`
  - パラメータ: プロジェクトID
- **テスト結果取得**:
  - エンドポイント: `GET /projects/:id/pipelines/:pipeline_id/jobs`
  - パラメータ: プロジェクトID、パイプラインID

#### 3. データ取得フロー

1. **初期設定**:
   - 設定画面でGitLabのURLとPersonal Access Tokenを入力・保存。
   - 設定ファイルにトークンとURLを安全に保存。

2. **メトリクス収集スケジュール**:
   - **バッチ処理**: Spring Schedulerを使用して、1日1回のメトリクス収集ジョブをスケジュール。
   - **手動トリガー**: 「今すぐ更新」ボタンから手動でメトリクス収集を開始可能。

3. **データ取得プロセス**:
   - **イベントごとのチーム取得**:
     - 現在開催中のイベントに紐づくチーム一覧をデータベースから取得。
   - **各チームのリポジトリ情報取得**:
     - チームごとにGitLabプロジェクトIDを取得（チーム名とイベントIDを基にマッピング）。
   - **コミット情報取得**:
     - 各プロジェクトの指定ブランチ（ブランチルールに基づく）からコミット情報を取得。
   - **テスト結果取得**:
     - パイプラインIDを取得し、関連するジョブのテスト結果を取得。
   - **データマッピングおよび保存**:
     - 取得したデータを内部データ構造（メトリクステーブル）にマッピングし、データベースに保存。

#### 4. データマッピング

- **コミット情報**:
  - GitLabのコミットデータを、メトリクステーブルの`metric_value`として保存。
  - `participant_gitlab_id`および`participant_gitlab_email`を使用して、コミットを特定の参加者に紐付け。

- **ブランチ情報**:
  - ブランチ名を取得し、ブランチルール設定テーブルと照合して命名規則の遵守を確認。
  - 規則に違反するブランチが存在する場合、警告メッセージを生成。

- **テスト結果**:
  - テストの成功・失敗情報をメトリクステーブルに保存し、変更失敗率として計算。

#### 5. エラーハンドリング

- **API呼び出しエラー**:
  - GitLab APIからのエラーレスポンス（例: 401 Unauthorized, 404 Not Found）を適切に処理。
  - エラー発生時はログに記録し、ユーザーに通知。

- **データ整合性エラー**:
  - データベースへの保存時にエラーが発生した場合、トランザクションをロールバック。
  - エラーメッセージをユーザーに提供し、再試行を促す。

- **ネットワークエラー**:
  - 一時的なネットワーク障害に対しては、リトライメカニズムを実装。
  - リトライ回数を制限し、回数超過時はエラーとして処理。

## メトリクス収集機能 基本設計

### 概要

本セクションでは、新人ハッカソン研修向けの**開発生産性管理ツール**における**メトリクス収集機能**の基本設計について詳細を示します。この機能は、指定されたイベントに紐づくチームおよび個々の参加者の開発活動データを定期的に収集し、分析可能なメトリクスを生成します。メトリクス収集は、バッチ処理および手動トリガーの両方で実行可能であり、運営やメンターがリアルタイムでチームおよび個人の開発状況を把握し、適切なフィードバックを提供するための基盤を提供します。

### 機能構成

メトリクス収集機能は以下の主要コンポーネントで構成されます。

1. **スケジューラー**
   - 定期的なバッチ処理を管理し、メトリクス収集ジョブを実行します。

2. **APIクライアント**
   - GitLab APIと通信し、必要なデータ（コミット情報、ブランチ情報、テスト結果）を取得します。

3. **データ処理モジュール**
   - 取得したデータを解析・加工し、必要なメトリクスを計算します。

4. **データ保存モジュール**
   - 計算されたメトリクスをデータベースに保存します。

5. **手動トリガーインターフェース**
   - ユーザーが「今すぐ更新」ボタンを使用してメトリクス収集を手動で開始できるようにします。

6. **ユーザ定義メトリクス管理**
   - ユーザーがGUIを通じて新しいメトリクスを定義し、収集対象に追加できる機能を提供します。

### ワークフロー

1. **メトリクス収集のトリガー**
   - **定期実行**: Spring Schedulerが設定されたスケジュール（デフォルトは毎日午前2時）に基づいてメトリクス収集ジョブを実行。
   - **手動実行**: ユーザーが「今すぐ更新」ボタンをクリックすることで、即時にメトリクス収集ジョブを開始。

2. **データ取得プロセス**
   - **イベントごとのチーム取得**:
     - 現在開催中のイベントに紐づくチーム一覧をデータベースから取得。
   - **各チームのリポジトリ情報取得**:
     - チームごとにGitLabプロジェクトIDを取得（チーム名とイベントIDを基にマッピング）。
   - **コミット情報取得**:
     - 各プロジェクトのコミット情報を取得。
   - **テスト結果取得**:
     - パイプラインIDを取得し、関連するジョブのテスト結果を取得。

3. **データ処理およびメトリクス計算**
   - **チーム別メトリクス**
     - **コミット数**:
       - 各チームの総コミット数をカウント。
     - **デプロイ頻度**:
       - メインブランチへのマージ回数をカウント。
     - **変更失敗率**:
       - メインブランチへのマージ時のテスト失敗率を計算。
     - **変更リードタイム**:
       - Storyブランチの平均生存時間を計算。
   - **参加者別メトリクス**
     - **コミット数**:
       - 各参加者のコミット数をカウント。
     - **デプロイ頻度**:
       - 各参加者が関与したメインブランチへのマージ回数をカウント。
     - **変更失敗率**:
       - 各参加者が関与したテスト失敗率を計算。
     - **変更リードタイム**:
       - 各参加者が関与したStoryブランチの平均生存時間を計算。
   - **ユーザ定義メトリクス**
     - ユーザーが定義した追加のメトリクスに基づき、データ収集および計算を実施。

4. **データ保存**
   - 計算されたチーム別メトリクスを**Metrics**テーブルに保存。
   - 計算された参加者別メトリクスを**ParticipantMetrics**テーブルに保存。
   - 同一日に保存できるスナップショットは一つまで（最新の更新後データを保存）

5. **エラーハンドリングおよびロギング**
   - 各ステップで発生する可能性のあるエラーを適切に処理し、ログに記録。
   - 致命的なエラー時にはジョブを中断し、管理者に通知。

## エラーハンドリング

### エラーハンドリングの方針

**（前提）ログの基本方針** 
- ログは標準出力に出力する。ファイル出力は不要。

**ユーザーへの通知**  
- ユーザーに対しては、具体的なエラーメッセージを表示し、入力の修正や再試行を促します。

**ユーザーへのフィードバック**  
- フォーム入力時にリアルタイムでバリデーションを行い、エラーがあれば即座にフィードバックを提供します。  
- エラーメッセージは具体的かつ分かりやすく表示し、ユーザーが問題を理解しやすいようにします。

### エラーハンドリングの実装方針

#### バックエンド（Spring Boot）

**一元的な例外処理**  
- グローバルな例外ハンドラーを実装し(AOP等を利用)、全てのコントローラーで発生する例外を一元的に処理します。

**カスタム例外の利用**  
- ビジネスロジックに特化したカスタム例外を定義し、明確なエラーメッセージを提供します。

**トランザクション管理**  
- データベース操作中にエラーが発生した場合は、トランザクションをロールバックし、データの整合性を保ちます。

**外部サービス連携のエラーハンドリング**  
- GitLab APIとの通信エラー時には、リトライメカニズムを実装し、一定回数失敗した場合はエラーとして処理します。

#### フロントエンド（HTML/CSS/JavaScript）

**エラーメッセージの表示**  
- フロントエンドでは、バックエンドから受け取ったエラーレスポンスを基に、ユーザーに適切なエラーメッセージを表示します。  
- Bootstrapのアラートコンポーネントを使用して視覚的にエラーを通知します。

**入力バリデーション**  
- クライアントサイドでも入力バリデーションを実施し、ユーザーエラーを未然に防ぎます。

## 開発時考慮事項

- プロファイル(application-~.properties利用):
  - dev: H2 使用、GitLab 実アクセスあり
  - prod: PostgreSQL 使用、本番 GitLab アクセス
  - mock: H2 または PostgreSQL 使用可能、GitLab API 部分は MockGitLabClient で固定データ返却
- システム構成の前提
  - java17
  - Spring Boot 3.3.6
  - Maven
  - DB
    - postgresql(本番)
    - h2(開発)
  - パッケージ
  　- sak.metricstool.~
- GitLab API連携の方針
  - APIにサービス層から直接アクセスはしない。
  - APIにアクセスするクラスはインテグレーション層（GitLabClient）に作成。
  - サービス層とインテグレーション層を適切に分割することにより、保守性を高める。
- lombokを利用してできるだけコードは最小化する
- 初期データ投入 (data.sql) でイベント・チーム・参加者・メトリクスサンプルを大量登録し、画面検証容易化
- MockGitLabClient では大量コミット・パイプラインデータを固定返却し、UI 表示やパフォーマンス検証可能
- ユーザ定義メトリクスの実装は対象範囲外とする